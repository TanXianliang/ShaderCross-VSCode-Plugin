<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Shader Cross Explorer</title>
	<style>
		:root {
			--primary-bg: #1e1e1e;
			--secondary-bg: #252526;
			--tertiary-bg: #333333;
			--text-color: #d4d4d4;
			--text-muted: #8a8a8a;
			--border-color: #333333;
			--accent-color: #0078d7;
			--hover-color: #005a9e;
			--tree-line-color: #444444;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
			background-color: var(--primary-bg);
			color: var(--text-color);
			height: 100vh;
			display: flex;
			flex-direction: column;
			min-width: 320px;
		}

		/* Header Styles */
		.header {
			padding: 10px 16px;
			background-color: var(--secondary-bg);
			border-bottom: 1px solid var(--border-color);
			display: flex;
			align-items: center;
			justify-content: space-between;
		}

		.header-title {
			font-size: 16px;
			font-weight: 600;
		}

		.toolbar {
			display: flex;
			gap: 12px;
		}

		.toolbar-button {
			background: none;
			border: none;
			color: var(--text-color);
			cursor: pointer;
			width: 28px;
			height: 28px;
			border-radius: 4px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.toolbar-button:hover {
			background-color: var(--tertiary-bg);
		}

		/* Main Content Styles */
		.main-content {
			flex-grow: 1;
			display: flex;
			overflow: hidden;
		}

		/* Explorer Panel Styles */
		.explorer-panel {
			width: 250px;
			background-color: var(--secondary-bg);
			border-right: 1px solid var(--border-color);
			display: flex;
			flex-direction: column;
		}

		.explorer-header {
			padding: 10px 12px;
			font-weight: 600;
			border-bottom: 1px solid var(--border-color);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.explorer-tree {
			flex-grow: 1;
			overflow-y: auto;
			padding: 10px 0;
		}

		/* Tree Item Styles */
		.tree-item {
			display: flex;
			align-items: center;
			padding: 6px 12px;
			cursor: pointer;
			position: relative;
		}

		.tree-item:hover {
			background-color: var(--tertiary-bg);
		}

		.tree-item.active {
			background-color: var(--accent-color);
			color: white;
		}

		.tree-toggle {
			width: 16px;
			height: 16px;
			margin-right: 4px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.tree-icon {
			width: 16px;
			height: 16px;
			margin-right: 4px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		/* Content Area Styles */
		.content-area {
			flex-grow: 1;
			display: flex;
			flex-direction: column;
			overflow: hidden;
			padding: 16px;
		}

		.no-selection {
			flex-grow: 1;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			color: var(--text-muted);
		}

		.no-selection svg {
			width: 64px;
			height: 64px;
			margin-bottom: 16px;
		}

		/* Editor Styles */
		.editor-container {
			flex-grow: 1;
			margin-top: 24px;
			display: flex;
			flex-direction: column;
			background-color: var(--secondary-bg);
			border-radius: 4px;
			overflow: hidden;
		}

		.editor-header {
			padding: 10px 12px;
			border-bottom: 1px solid var(--border-color);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.editor-filename {
			font-size: 14px;
			color: var(--text-muted);
		}

		.editor-content {
			flex-grow: 1;
			overflow: hidden;
		}

		textarea {
			width: 100%;
			height: 100%;
			background-color: var(--secondary-bg);
			color: var(--text-color);
			border: none;
			padding: 12px;
			font-family: 'Consolas', 'Monaco', monospace;
			resize: none;
			outline: none;
		}

		/* Compiler Controls */
		.compiler-controls {
			margin-top: 24px;
			display: flex;
			gap: 10px;
			align-items: center;
		}

		select {
			background-color: var(--secondary-bg);
			color: var(--text-color);
			border: 1px solid var(--border-color);
			border-radius: 4px;
			padding: 8px 8px;
		}

		button {
			background-color: var(--accent-color);
			color: white;
			border: none;
			border-radius: 4px;
			padding: 8px 16px;
			cursor: pointer;
			font-size: 14px;
		}

		button:hover {
			background-color: var(--hover-color);
		}

		/* Output Panel */
		.output-panel {
			margin-top: 24px;
			background-color: var(--secondary-bg);
			border-radius: 4px;
			border: 1px solid var(--border-color);
			display: flex;
			flex-direction: column;
		}

		.output-header {
			padding: 8px 12px;
			border-bottom: 1px solid var(--border-color);
			font-weight: 600;
		}

		.output-content {
			flex-grow: 1;
			height: 150px;
			overflow-y: auto;
			padding: 12px;
			font-family: 'Consolas', 'Monaco', monospace;
			font-size: 14px;
		}
	</style>
</head>
<body>
	<div class="compiler-header" style="margin-bottom: 16px; min-width: 200px;">
		<div class="header-title">Compiler Options</div>
	</div>
	<div class="compiler-options">
		<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
			<div class="compiler-type" style="min-width: 128px; min-height: 20px; max-height: 20px;">Compiler</div>
			<select class="compiler-select" style="flex-grow: 1; min-width: 150px;">
				<option value="dxc">DXC</option>
				<option value="fxc">FXC</option>
				<option value="glslang">GLSLang</option>
			</select>
		</div>
		<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
			<div class="shader-type" style="min-width: 128px; min-height: 20px;">Shader Type</div>
			<select class="shader-type-select" style="flex-grow: 1; min-width: 150px;">
				<option value="vs">Vertex</option>
				<option value="ps">Pixel</option>
				<option value="gs">Geometry</option>
				<option value="hs">Hull</option>
				<option value="ds">Domain</option>
				<option value="cs" selected>Compute</option>
				<option value="rgen">RayGeneration</option>
				<option value="rint">RayIntersection</option>
				<option value="rahit">RayAnyHit</option>
				<option value="rchit">RayClosest Hit</option>
				<option value="rmiss">RayMiss</option>
				<option value="rcall">RayCallable</option>
				<option value="rs">Amplification</option>
				<option value="ms">Mesh</option>
			</select>
		</div>
		<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
			<div class="shader-mode" style="min-width: 128px; min-height: 20px;">Shader Mode</div>
			<select class="shader-mode-select" style="flex-grow: 1; min-width: 150px;">
				<option value="5_0">sm5.0</option>
				<option value="5_1">sm5.1</option>
				<option value="6_0">sm6.0</option>
				<option value="6_1">sm6.1</option>
				<option value="6_2">sm6.2</option>
				<option value="6_3">sm6.3</option>
				<option value="6_4">sm6.4</option>
				<option value="6_5">sm6.5</option>
				<option value="6_6" selected>sm6.6</option>
				<option value="6_7">sm6.7</option>
				<option value="6_8">sm6.8</option>
				<option value="450">450</option>
				<option value="460">460</option>
			</select>
		</div>
		<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
			<div class="output-type" style="min-width: 128px; min-height: 20px;">Output Type</div>
			<select class="output-type-select" style="flex-grow: 1; min-width: 150px;">
				<option value="DXIL">DXIL</option>
				<option value="DXBC">DXBC</option>
				<option value="SPIR-V">SPIR-V</option>
				<option value="HLSL">HLSL</option>
				<option value="HLSL-Preprocess">HLSL-Preprocess</option>
				<option value="GLSL">GLSL</option>
				<option value="MSL">MSL</option>
			</select>
		</div>
		<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
			<div class="entry-point" style="min-width: 128px; min-height: 20px;">Entry Point</div>
			<input type="text" class="entry-point-input" placeholder="main" style="background-color: var(--secondary-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 6px 8px; flex-grow: 1;">
		</div>
		<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
			<div class="additional-option" style="min-width: 104px; min-height: 20px;">Additional Option</div>
			<input type="checkbox" class="additional-option-checkbox" style="width: 12px; height: 12px; min-width: 12px; min-height: 12px; max-width: 12px; max-height: 12px;">
			<input type="text" class="additional-option-input" placeholder="Enter additional option" style="background-color: var(--secondary-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 6px 8px; flex-grow: 1;">
		</div>
	</div>
	</div>
	<div style="height: 1px; background-color: var(--border-color); margin: 16px 0;"></div>
	
	<div class="shadercode-header" style="margin-bottom: 16px;">
		<div class="header-title" style="min-width: 200px;">Shader Code Options</div>
	</div>
	<div class="shadercode-options">
		<div style="display: flex; align-items: center; gap: 12px;">
			<div class="shader-language" style="min-width: 128px; min-height: 20px;">Shader Language</div>
			<select class="shader-language-select" style="flex-grow: 1; min-width: 150px;">
				<option value="hlsl">HLSL</option>
				<option value="hlsl2021" selected>HLSL2021</option>
				<option value="glsl">GLSL</option>
			</select>
		</div>
		<div style="display: flex; flex-direction: column; margin-top: 16px;">
			<div style="display: flex; align-items: center; margin-bottom: 8px;">
				<div class="macro-definitions" style="min-width: 128px; min-height: 20px; flex-grow: 1;">Macros-Definitions</div>
				<button class="add-macro-button" style="background-color: var(--accent-color); color: white; border: none; border-radius: 4px; width: 28px; height: 28px; padding: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
				</button>
			</div>
			<div class="macro-list" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 8px; border: 1px solid var(--border-color); border-radius: 4px; padding: 8px; background-color: var(--secondary-bg); max-height: 200px; overflow-y: auto;">
				<!-- 默认宏定义示例 -->
				<div class="macro-item" style="display: flex; align-items: center; gap: 12px; padding: 4px 0;">
					<div class="macro-value" style="flex-grow: 1; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--primary-bg);">DEBUG=1</div>
					<button class="remove-macro-button" style="background-color: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 4px;">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
					</button>
				</div>
				<div class="macro-item" style="display: flex; align-items: center; gap: 12px; padding: 4px 0;">
					<div class="macro-value" style="flex-grow: 1; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--primary-bg);">ENABLE_FEATURE_X=1</div>
					<button class="remove-macro-button" style="background-color: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 4px;">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
					</button>
				</div>
			</div>
		</div>
		
		<!-- Include Paths 列表 -->
		<div style="display: flex; flex-direction: column; margin-top: 16px;">
			<div style="display: flex; align-items: center; margin-bottom: 8px;">
				<div class="include-paths" style="min-width: 128px; min-height: 20px; flex-grow: 1;">Include Paths</div>
				<button class="add-include-path-button" style="background-color: var(--accent-color); color: white; border: none; border-radius: 4px; padding: 4px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
  					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
				</button>
			</div>
			<div class="include-path-list" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 8px; border: 1px solid var(--border-color); border-radius: 4px; padding: 8px; background-color: var(--secondary-bg); max-height: 200px; overflow-y: auto;">
				<!-- 默认包含路径示例 -->
				<div class="include-path-item" style="display: flex; align-items: center; gap: 12px; padding: 4px 0;">
					<div class="include-path-value" style="flex-grow: 1; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--primary-bg);">../include</div>
					<button class="remove-include-path-button" style="background-color: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 4px;">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
					</button>
				</div>
			</div>
		</div>
    <!-- 编译按钮 -->
    <div style="margin-top: 24px;">
      <button id="compile-shader-button" style="background-color: var(--accent-color); color: white; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer; font-size: 14px; width: 100%;">
        Compile Shader
      </button>
    </div>
  </div>
</div>
<script>
	// 宏定义列表功能实现
	document.addEventListener('DOMContentLoaded', function() {
		// 添加宏按钮点击事件
		document.querySelector('.add-macro-button').addEventListener('click', function() {
			// 创建新的宏定义项
			const macroItem = document.createElement('div');
			macroItem.className = 'macro-item';
			macroItem.style.display = 'flex';
			macroItem.style.alignItems = 'center';
			macroItem.style.gap = '12px';
			macroItem.style.padding = '4px 0';
			
			// 创建宏值显示（可编辑）
			const macroValueEl = document.createElement('div');
			macroValueEl.className = 'macro-value';
			macroValueEl.style.flexGrow = '1';
			macroValueEl.style.padding = '4px 8px';
			macroValueEl.style.border = '1px solid var(--border-color)';
			macroValueEl.style.borderRadius = '4px';
			macroValueEl.style.backgroundColor = 'var(--primary-bg)';
			macroValueEl.textContent = ''; // 初始为空
			macroValueEl.setAttribute('data-placeholder', 'Example: NAME=VALUE');
			
			// 添加占位符逻辑
			function updatePlaceholder() {
				if (macroValueEl.textContent.trim() === '') {
					macroValueEl.style.color = 'var(--text-muted)';
					macroValueEl.textContent = macroValueEl.getAttribute('data-placeholder');
				} else {
					macroValueEl.style.color = 'var(--text-color)';
				}
			}
			
			// 初始化占位符
			updatePlaceholder();
			
			// 添加点击事件以清除占位符
			macroValueEl.addEventListener('click', function() {
				if (macroValueEl.textContent === macroValueEl.getAttribute('data-placeholder')) {
					macroValueEl.textContent = '';
					macroValueEl.style.color = 'var(--text-color)';
				}
			});
			
			// 添加失去焦点事件以恢复占位符并保存配置
			macroValueEl.addEventListener('blur', function() {
				updatePlaceholder();
				// 失焦后保存配置
				saveCurrentConfiguration();
			});
			
			// 添加键盘事件，支持Enter保存
			macroValueEl.addEventListener('keydown', function(event) {
				if (event.key === 'Enter') {
					event.preventDefault();
					macroValueEl.blur();
					// Enter后保存配置
					saveCurrentConfiguration();
				} else if (event.key === 'Escape') {
					event.preventDefault();
					macroValueEl.blur();
				}
			});
			
			// 使元素可编辑
			macroValueEl.contentEditable = true;
			
			// 创建删除按钮
			const removeButton = document.createElement('button');
			removeButton.className = 'remove-macro-button';
			removeButton.style.backgroundColor = 'transparent';
			removeButton.style.border = 'none';
			removeButton.style.color = 'var(--text-muted)';
			removeButton.style.cursor = 'pointer';
			removeButton.style.padding = '4px';
			removeButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';

			// 添加删除事件并保存配置
			removeButton.addEventListener('click', function() {
				macroItem.remove();
				// 删除后保存配置
				saveCurrentConfiguration();
			});
			
			// 添加到列表
			macroItem.appendChild(macroValueEl);
			macroItem.appendChild(removeButton);
			document.querySelector('.macro-list').appendChild(macroItem);
			
			// 自动聚焦到新创建的宏项
			macroValueEl.click();
			// 添加新宏项后保存配置
			saveCurrentConfiguration();
		});
		
		// 为现有删除按钮添加点击事件
		document.querySelectorAll('.remove-macro-button').forEach(button => {
			button.addEventListener('click', function() {
				this.parentElement.remove();
			});
		});
		
		// 获取VS Code API
		const vscode = acquireVsCodeApi();

		// 编译按钮点击事件
		document.getElementById('compile-shader-button').addEventListener('click', function() {
			// 获取所有编译参数
			const compilerSelect = document.querySelector('.compiler-select');
			const shaderTypeSelect = document.querySelector('.shader-type-select');
			const shaderModeSelect = document.querySelector('.shader-mode-select');
			const outputTypeSelect = document.querySelector('.output-type-select');
			const entryPointInput = document.querySelector('.entry-point-input');
			const additionalOptionCheckbox = document.querySelector('.additional-option-checkbox');
			const additionalOptionInput = document.querySelector('.additional-option-input');
			const shaderLanguageSelect = document.querySelector('.shader-language-select');
			
			// 获取宏定义
			const macroItems = document.querySelectorAll('.macro-item .macro-value');
			const macros = Array.from(macroItems).map(item => item.textContent.trim());
			
			// 获取包含路径
			const includePathItems = document.querySelectorAll('.include-path-item .include-path-value');
			const includePaths = Array.from(includePathItems).map(item => item.textContent.trim());
			
			// 发送编译命令和参数
			vscode.postMessage({
				command: 'compileShader',
				shaderLanguage: shaderLanguageSelect.value,
				compiler: compilerSelect.value,
				shaderType: shaderTypeSelect.value,
				shaderMode: shaderModeSelect.value,
				outputType: outputTypeSelect.value,
				entryPoint: entryPointInput.value.trim(),
				additionalOptionEnabled: additionalOptionCheckbox.checked,
				additionalOption: additionalOptionInput.value.trim(),
				shaderLanguage: shaderLanguageSelect.value,
				macros: macros,
				includePaths: includePaths
			});
		});
		
		
		// Include Path 列表功能实现
		// 添加Include Path按钮点击事件
		document.querySelector('.add-include-path-button').addEventListener('click', function() {
			// 发送消息给扩展程序，请求打开文件夹选择对话框
			vscode.postMessage({
				command: 'openIncludeFloderDialg'
			});
		});
		
		// 监听来自扩展程序的消息
		window.addEventListener('message', event => {
			const message = event.data;
			if (message.command === 'folderSelected' && message.path) {
				// 创建新的Include Path项
				const includePathItem = document.createElement('div');
				includePathItem.className = 'include-path-item';
				includePathItem.style.display = 'flex';
				includePathItem.style.alignItems = 'center';
				includePathItem.style.gap = '12px';
				includePathItem.style.padding = '4px 0';
				
				// 创建Include Path值显示
				const includePathValueEl = document.createElement('div');
				includePathValueEl.className = 'include-path-value';
				includePathValueEl.style.flexGrow = '1';
				includePathValueEl.style.padding = '4px 8px';
				includePathValueEl.style.border = '1px solid var(--border-color)';
				includePathValueEl.style.borderRadius = '4px';
				includePathValueEl.style.backgroundColor = 'var(--primary-bg)';
				includePathValueEl.textContent = message.path;
				
				// 创建删除按钮
				const removeButton = document.createElement('button');
				removeButton.className = 'remove-include-path-button';
				removeButton.style.backgroundColor = 'transparent';
				removeButton.style.border = 'none';
				removeButton.style.color = 'var(--text-muted)';
				removeButton.style.cursor = 'pointer';
				removeButton.style.padding = '4px';
				removeButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
				
				// 添加删除事件
				removeButton.addEventListener('click', function() {
					includePathItem.remove();
					// 删除后保存配置
					saveCurrentConfiguration();
				});
				
				// 添加到列表
				includePathItem.appendChild(includePathValueEl);
				includePathItem.appendChild(removeButton);
				document.querySelector('.include-path-list').appendChild(includePathItem);
				// 添加后保存配置
				saveCurrentConfiguration();
			} else if (message.command === 'compileResult' && message.result) {
				// TODO
			} else if (message.command === 'restoreConfiguration' && message.config) {
				// 恢复保存的配置
				restoreConfiguration(message.config);
			}
		});

		// 恢复配置函数
		function restoreConfiguration(config) {
			console.log('恢复配置开始...', config);
			// 恢复基本选择项
			if (config.compiler) document.querySelector('.compiler-select').value = config.compiler;
			if (config.shaderType) document.querySelector('.shader-type-select').value = config.shaderType;
			if (config.shaderMode) document.querySelector('.shader-mode-select').value = config.shaderMode;
			if (config.outputType) document.querySelector('.output-type-select').value = config.outputType;
			if (config.entryPoint) document.querySelector('.entry-point-input').value = config.entryPoint;
			if (config.additionalOptionEnabled !== undefined) document.querySelector('.additional-option-checkbox').checked = config.additionalOptionEnabled;
			if (config.additionalOption) document.querySelector('.additional-option-input').value = config.additionalOption;
			if (config.shaderLanguage) document.querySelector('.shader-language-select').value = config.shaderLanguage;

			// 恢复宏定义
			if (config.macros && Array.isArray(config.macros)) {
				const macroList = document.querySelector('.macro-list');
				// 清空现有宏列表（保留占位符或不保留，根据需要调整）
				macroList.innerHTML = '';

				config.macros.forEach(macroValue => {
					if (macroValue && macroValue.trim()) {
						// 创建宏定义项
						const macroItem = document.createElement('div');
						macroItem.className = 'macro-item';
						macroItem.style.display = 'flex';
						macroItem.style.alignItems = 'center';
						macroItem.style.gap = '12px';
						macroItem.style.padding = '4px 0';

						const macroValueEl = document.createElement('div');
						macroValueEl.className = 'macro-value';
						macroValueEl.style.flexGrow = '1';
						macroValueEl.style.padding = '4px 8px';
						macroValueEl.style.border = '1px solid var(--border-color)';
						macroValueEl.style.borderRadius = '4px';
						macroValueEl.style.backgroundColor = 'var(--primary-bg)';
						macroValueEl.textContent = macroValue;
						macroValueEl.setAttribute('data-placeholder', 'Example: NAME=VALUE');
						macroValueEl.contentEditable = true;

						// 添加占位符逻辑
						function updatePlaceholder() {
							if (macroValueEl.textContent.trim() === '') {
								macroValueEl.style.color = 'var(--text-muted)';
								macroValueEl.textContent = macroValueEl.getAttribute('data-placeholder');
							} else {
								macroValueEl.style.color = 'var(--text-color)';
							}
						}

						macroValueEl.addEventListener('blur', function() {
							updatePlaceholder();
							saveCurrentConfiguration();
						});

						const removeButton = document.createElement('button');
						removeButton.className = 'remove-macro-button';
						removeButton.style.backgroundColor = 'transparent';
						removeButton.style.border = 'none';
						removeButton.style.color = 'var(--text-muted)';
						removeButton.style.cursor = 'pointer';
						removeButton.style.padding = '4px';
						removeButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
						removeButton.addEventListener('click', function() {
							macroItem.remove();
							saveCurrentConfiguration();
						});

						macroItem.appendChild(macroValueEl);
						macroItem.appendChild(removeButton);
						macroList.appendChild(macroItem);
					}
				});
			}

			// 恢复包含路径
			if (config.includePaths && Array.isArray(config.includePaths)) {
				const includePathList = document.querySelector('.include-path-list');
				// 清空现有包含路径列表（保留占位符或不保留，根据需要调整）
				includePathList.innerHTML = '';

				config.includePaths.forEach(pathValue => {
					if (pathValue && pathValue.trim()) {
						// 创建Include Path项
						const includePathItem = document.createElement('div');
						includePathItem.className = 'include-path-item';
						includePathItem.style.display = 'flex';
						includePathItem.style.alignItems = 'center';
						includePathItem.style.gap = '12px';
						includePathItem.style.padding = '4px 0';

						const includePathValueEl = document.createElement('div');
						includePathValueEl.className = 'include-path-value';
						includePathValueEl.style.flexGrow = '1';
						includePathValueEl.style.padding = '4px 8px';
						includePathValueEl.style.border = '1px solid var(--border-color)';
						includePathValueEl.style.borderRadius = '4px';
						includePathValueEl.style.backgroundColor = 'var(--primary-bg)';
						includePathValueEl.textContent = pathValue;

						const removeButton = document.createElement('button');
						removeButton.className = 'remove-include-path-button';
						removeButton.style.backgroundColor = 'transparent';
						removeButton.style.border = 'none';
						removeButton.style.color = 'var(--text-muted)';
						removeButton.style.cursor = 'pointer';
						removeButton.style.padding = '4px';
						removeButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
						removeButton.addEventListener('click', function() {
							includePathItem.remove();
							saveCurrentConfiguration();
						});

						includePathItem.appendChild(includePathValueEl);
						includePathItem.appendChild(removeButton);
						includePathList.appendChild(includePathItem);
					}
				});
			}
		}

		// 保存当前配置函数
		function saveCurrentConfiguration() {
			console.log('保存配置开始...');
			// 获取所有配置项
			const compilerSelect = document.querySelector('.compiler-select');
			const shaderTypeSelect = document.querySelector('.shader-type-select');
			const shaderModeSelect = document.querySelector('.shader-mode-select');
			const outputTypeSelect = document.querySelector('.output-type-select');
			const entryPointInput = document.querySelector('.entry-point-input');
			const additionalOptionCheckbox = document.querySelector('.additional-option-checkbox');
			const additionalOptionInput = document.querySelector('.additional-option-input');
			const shaderLanguageSelect = document.querySelector('.shader-language-select');
			
			// 获取宏定义
			const macroItems = document.querySelectorAll('.macro-item .macro-value');
			const macros = Array.from(macroItems).map(item => {
				const text = item.textContent.trim();
				const placeholder = item.getAttribute('data-placeholder');
				return text !== placeholder ? text : '';
			}).filter(text => text);
			
			// 获取包含路径
			const includePathItems = document.querySelectorAll('.include-path-item .include-path-value');
			const includePaths = Array.from(includePathItems).map(item => item.textContent.trim()).filter(path => path);
			
			// 构建配置对象
			const currentConfig = {
				compiler: compilerSelect.value,
				shaderType: shaderTypeSelect.value,
				shaderMode: shaderModeSelect.value,
				outputType: outputTypeSelect.value,
				entryPoint: entryPointInput.value.trim(),
				additionalOptionEnabled: additionalOptionCheckbox.checked,
				additionalOption: additionalOptionInput.value.trim(),
				shaderLanguage: shaderLanguageSelect.value,
				macros: macros,
				includePaths: includePaths
			};
			
			// 发送配置到扩展保存
			vscode.postMessage({
				command: 'saveConfiguration',
				config: currentConfig
			});
		}

		// 为所有选择框和输入框添加变更事件，自动保存配置
		document.querySelectorAll('select, input[type="text"], input[type="checkbox"]').forEach(element => {
			element.addEventListener('change', saveCurrentConfiguration);
		});

		// 修改宏定义添加按钮，添加后保存配置
		document.querySelector('.add-macro-button').addEventListener('click', function(originalEvent) {
			// 保存原始的事件处理函数
			const originalHandler = function() {
				// 原始逻辑已经在DOMContentLoaded中设置
				// 这里我们只需要确保在添加后保存配置
				setTimeout(saveCurrentConfiguration, 100); // 延迟保存，确保DOM更新完成
			};
			originalHandler.apply(this, arguments);
		});
		
		// 为现有删除按钮添加点击事件
		document.querySelectorAll('.remove-include-path-button').forEach(button => {
			button.addEventListener('click', function() {
				this.parentElement.remove();
			});
		});

		
		// 允许宏值双击编辑
		document.addEventListener('dblclick', function(e) {
			if (e.target.classList.contains('macro-value')) {
				const currentValue = e.target.textContent;
				const input = document.createElement('input');
				input.type = 'text';
				input.value = currentValue;
				input.style.width = '100%';
				input.style.padding = '4px 8px';
				input.style.backgroundColor = 'var(--primary-bg)';
				input.style.color = 'var(--text-color)';
				input.style.border = '1px solid var(--accent-color)';
				input.style.borderRadius = '4px';
				
				e.target.parentNode.replaceChild(input, e.target);
				input.focus();
				
				// 失去焦点时保存
				input.addEventListener('blur', function() {
					const newValue = input.value.trim();
					const macroValueEl = document.createElement('div');
					macroValueEl.className = 'macro-value';
					macroValueEl.style.flexGrow = '1';
					macroValueEl.style.padding = '4px 8px';
					macroValueEl.style.border = '1px solid var(--border-color)';
					macroValueEl.style.borderRadius = '4px';
					macroValueEl.style.backgroundColor = 'var(--primary-bg)';
					macroValueEl.textContent = newValue || currentValue;
					input.parentNode.replaceChild(macroValueEl, input);
				});
				
				// 按Enter键保存
				input.addEventListener('keydown', function(e) {
					if (e.key === 'Enter') {
						input.blur();
					}
				});
			}
		});
	});
</script>
</body>
</html>