<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Shader Cross Explorer</title>
	<style>
		:root {
			--primary-bg: #1e1e1e;
			--secondary-bg: #252526;
			--tertiary-bg: #333333;
			--text-color: #d4d4d4;
			--text-muted: #8a8a8a;
			--border-color: #333333;
			--accent-color: #0078d7;
			--hover-color: #005a9e;
			--tree-line-color: #444444;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
			background-color: var(--primary-bg);
			color: var(--text-color);
			height: 100vh;
			display: flex;
			flex-direction: column;
			min-width: 320px;
		}

		/* Header Styles */
		.header {
			padding: 10px 16px;
			background-color: var(--secondary-bg);
			border-bottom: 1px solid var(--border-color);
			display: flex;
			align-items: center;
			justify-content: space-between;
		}

		.header-title {
			font-size: 16px;
			font-weight: 600;
		}

		.toolbar {
			display: flex;
			gap: 12px;
		}

		.toolbar-button {
			background: none;
			border: none;
			color: var(--text-color);
			cursor: pointer;
			width: 28px;
			height: 28px;
			border-radius: 4px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.toolbar-button:hover {
			background-color: var(--tertiary-bg);
		}

		/* Main Content Styles */
		.main-content {
			flex-grow: 1;
			display: flex;
			overflow: hidden;
		}

		/* Explorer Panel Styles */
		.explorer-panel {
			width: 250px;
			background-color: var(--secondary-bg);
			border-right: 1px solid var(--border-color);
			display: flex;
			flex-direction: column;
		}

		.explorer-header {
			padding: 10px 12px;
			font-weight: 600;
			border-bottom: 1px solid var(--border-color);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.explorer-tree {
			flex-grow: 1;
			overflow-y: auto;
			padding: 10px 0;
		}

		/* Tree Item Styles */
		.tree-item {
			display: flex;
			align-items: center;
			padding: 6px 12px;
			cursor: pointer;
			position: relative;
		}

		.tree-item:hover {
			background-color: var(--tertiary-bg);
		}

		.tree-item.active {
			background-color: var(--accent-color);
			color: white;
		}

		.tree-toggle {
			width: 16px;
			height: 16px;
			margin-right: 4px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.tree-icon {
			width: 16px;
			height: 16px;
			margin-right: 4px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		/* Content Area Styles */
		.content-area {
			flex-grow: 1;
			display: flex;
			flex-direction: column;
			overflow: hidden;
			padding: 16px;
		}

		.no-selection {
			flex-grow: 1;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			color: var(--text-muted);
		}

		.no-selection svg {
			width: 64px;
			height: 64px;
			margin-bottom: 16px;
		}

		/* Editor Styles */
		.editor-container {
			flex-grow: 1;
			margin-top: 24px;
			display: flex;
			flex-direction: column;
			background-color: var(--secondary-bg);
			border-radius: 4px;
			overflow: hidden;
		}

		.editor-header {
			padding: 10px 12px;
			border-bottom: 1px solid var(--border-color);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.editor-filename {
			font-size: 14px;
			color: var(--text-muted);
		}

		.editor-content {
			flex-grow: 1;
			overflow: hidden;
		}

		textarea {
			width: 100%;
			height: 100%;
			background-color: var(--secondary-bg);
			color: var(--text-color);
			border: none;
			padding: 12px;
			font-family: 'Consolas', 'Monaco', monospace;
			resize: none;
			outline: none;
		}

		/* Compiler Controls */
		.compiler-controls {
			margin-top: 24px;
			display: flex;
			gap: 10px;
			align-items: center;
		}

		select {
			background-color: var(--secondary-bg);
			color: var(--text-color);
			border: 1px solid var(--border-color);
			border-radius: 4px;
			padding: 8px 8px;
		}

		button {
			background-color: var(--accent-color);
			color: white;
			border: none;
			border-radius: 4px;
			padding: 8px 16px;
			cursor: pointer;
			font-size: 14px;
		}

		button:hover {
			background-color: var(--hover-color);
		}

		/* Output Panel */
		.output-panel {
			margin-top: 24px;
			background-color: var(--secondary-bg);
			border-radius: 4px;
			border: 1px solid var(--border-color);
			display: flex;
			flex-direction: column;
		}

		.output-header {
			padding: 8px 12px;
			border-bottom: 1px solid var(--border-color);
			font-weight: 600;
		}

		.output-content {
			flex-grow: 1;
			height: 150px;
			overflow-y: auto;
			padding: 12px;
			font-family: 'Consolas', 'Monaco', monospace;
			font-size: 14px;
		}
	</style>
</head>
<body>
	<div class="compiler-header" style="margin-bottom: 16px; min-width: 200px; display: flex; justify-content: space-between; align-items: center;">
		<div class="header-title">Compiler Options</div>
		<button id="menuButton" class="toolbar-button" style="background: none; border: none; color: var(--text-color); cursor: pointer; width: 28px; height: 28px; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
			≡
		</button>
	</div>

	<!-- 弹出菜单 -->
	<div id="menuPopup" style="display: none; position: fixed; top: 50px; right: 10px; background-color: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 4px; padding: 8px 0; min-width: 150px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); z-index: 1000;">
		<div id="versionInfo" style="padding: 8px 16px; color: var(--text-muted); font-size: 12px; cursor: default;">版本号: <span id="versionNumber">0.0.0</span></div>
	</div>
	<div class="compiler-options">
		<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
			<div class="compiler-type" style="min-width: 128px; min-height: 20px; max-height: 20px;">Compiler</div>
			<select class="compiler-select" style="flex-grow: 1; min-width: 150px;">
				<option value="dxc">DXC</option>
				<option value="fxc">FXC</option>
				<option value="glslang">GLSLang</option>
			</select>
		</div>
		<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
			<div class="shader-type" style="min-width: 128px; min-height: 20px;">Shader Type</div>
			<select class="shader-type-select" style="flex-grow: 1; min-width: 150px;">
				<option value="vs">Vertex</option>
				<option value="ps">Pixel</option>
				<option value="gs">Geometry</option>
				<option value="hs">Hull</option>
				<option value="ds">Domain</option>
				<option value="cs" selected>Compute</option>
				<option value="rgen">RayGeneration</option>
				<option value="rint">RayIntersection</option>
				<option value="rahit">RayAnyHit</option>
				<option value="rchit">RayClosest Hit</option>
				<option value="rmiss">RayMiss</option>
				<option value="rcall">RayCallable</option>
				<option value="rs">Amplification</option>
				<option value="ms">Mesh</option>
			</select>
		</div>
		<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
			<div class="shader-mode" style="min-width: 128px; min-height: 20px;">Shader Mode</div>
			<select class="shader-mode-select" style="flex-grow: 1; min-width: 150px;">
				<option value="5_0">sm5.0</option>
				<option value="5_1">sm5.1</option>
				<option value="6_0">sm6.0</option>
				<option value="6_1">sm6.1</option>
				<option value="6_2">sm6.2</option>
				<option value="6_3">sm6.3</option>
				<option value="6_4">sm6.4</option>
				<option value="6_5">sm6.5</option>
				<option value="6_6" selected>sm6.6</option>
				<option value="6_7">sm6.7</option>
				<option value="6_8">sm6.8</option>
				<option value="450">450</option>
				<option value="460">460</option>
			</select>
		</div>
		<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
			<div class="output-type" style="min-width: 128px; min-height: 20px;">Output Type</div>
			<select class="output-type-select" style="flex-grow: 1; min-width: 150px;">
				<option value="DXIL">DXIL</option>
				<option value="DXBC">DXBC</option>
				<option value="SPIR-V">SPIR-V</option>
				<option value="HLSL">HLSL</option>
				<option value="HLSL-Preprocess">HLSL-Preprocess</option>
				<option value="GLSL">GLSL</option>
				<option value="MSL">MSL</option>
			</select>
		</div>
		<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
			<div class="entry-point" style="min-width: 128px; min-height: 20px;">Entry Point</div>
			<input type="text" class="entry-point-input" placeholder="main" style="background-color: var(--secondary-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 6px 8px; flex-grow: 1;">
		</div>
		<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
			<div class="additional-option" style="min-width: 104px; min-height: 20px;">Additional Option</div>
			<input type="checkbox" class="additional-option-checkbox" style="width: 12px; height: 12px; min-width: 12px; min-height: 12px; max-width: 12px; max-height: 12px;">
			<input type="text" class="additional-option-input" placeholder="Enter additional option" style="background-color: var(--secondary-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 6px 8px; flex-grow: 1;">
		</div>
	</div>
	</div>
	<div style="height: 1px; background-color: var(--border-color); margin: 16px 0;"></div>
	
	<div class="shadercode-header" style="margin-bottom: 16px;">
		<div class="header-title" style="min-width: 200px;">Shader Code Options</div>
	</div>
	<div class="shadercode-options">
		<div style="display: flex; align-items: center; gap: 12px;">
			<div class="shader-language" style="min-width: 128px; min-height: 20px;">Shader Language</div>
			<select class="shader-language-select" style="flex-grow: 1; min-width: 150px;">
				<option value="hlsl">HLSL</option>
				<option value="hlsl2021" selected>HLSL2021</option>
				<option value="glsl">GLSL</option>
			</select>
		</div>
		<div style="display: flex; flex-direction: column; margin-top: 16px;">
			<div style="display: flex; align-items: center; margin-bottom: 8px;">
				<div class="macro-definitions" style="min-width: 128px; min-height: 20px; flex-grow: 1;">Macros-Definitions</div>
				<button class="add-macro-button" style="background-color: var(--accent-color); color: white; border: none; border-radius: 4px; width: 28px; height: 28px; padding: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
				</button>
			</div>
			<div class="macro-list" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 8px; border: 1px solid var(--border-color); border-radius: 4px; padding: 8px; background-color: var(--secondary-bg); max-height: 200px; overflow-y: auto;">
				<!-- 默认宏定义示例 -->
				<div class="macro-item" style="display: flex; align-items: center; gap: 12px; padding: 4px 0;">
					<div class="macro-value" style="flex-grow: 1; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--primary-bg);">DEBUG=1</div>
					<button class="remove-macro-button" style="background-color: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 4px;">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
					</button>
				</div>
				<div class="macro-item" style="display: flex; align-items: center; gap: 12px; padding: 4px 0;">
					<div class="macro-value" style="flex-grow: 1; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--primary-bg);">ENABLE_FEATURE_X=1</div>
					<button class="remove-macro-button" style="background-color: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 4px;">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
					</button>
				</div>
			</div>
		</div>
		
		<!-- Include Paths 列表 -->
		<div style="display: flex; flex-direction: column; margin-top: 16px;">
			<div style="display: flex; align-items: center; margin-bottom: 8px;">
				<div class="include-paths" style="min-width: 128px; min-height: 20px; flex-grow: 1;">Include Paths</div>
				<button class="add-include-path-button" style="background-color: var(--accent-color); color: white; border: none; border-radius: 4px; padding: 4px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
  					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
				</button>
			</div>
			<div class="include-path-list" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 8px; border: 1px solid var(--border-color); border-radius: 4px; padding: 8px; background-color: var(--secondary-bg); max-height: 200px; overflow-y: auto;">
				<!-- 默认包含路径示例 -->
				<div class="include-path-item" style="display: flex; align-items: center; gap: 12px; padding: 4px 0;">
					<div class="include-path-value" style="flex-grow: 1; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--primary-bg);">../include</div>
					<button class="remove-include-path-button" style="background-color: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 4px;">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
					</button>
				</div>
			</div>
		</div>
    <!-- 编译按钮 -->
    <div style="margin-top: 24px;">
      <button id="compile-shader-button" style="background-color: var(--accent-color); color: white; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer; font-size: 14px; width: 100%;">
        Compile Shader
      </button>
    </div>
  </div>
</div>
<script>
	// 宏定义列表功能实现
	document.addEventListener('DOMContentLoaded', function() {
		// 添加宏按钮点击事件
		document.querySelector('.add-macro-button').addEventListener('click', function() {
			// 创建新的宏定义项
			const macroItem = document.createElement('div');
			macroItem.className = 'macro-item';
			macroItem.style.display = 'flex';
			macroItem.style.alignItems = 'center';
			macroItem.style.gap = '12px';
			macroItem.style.padding = '4px 0';
			
			// 创建宏值显示（可编辑）
			const macroValueEl = document.createElement('div');
			macroValueEl.className = 'macro-value';
			macroValueEl.style.flexGrow = '1';
			macroValueEl.style.padding = '4px 8px';
			macroValueEl.style.border = '1px solid var(--border-color)';
			macroValueEl.style.borderRadius = '4px';
			macroValueEl.style.backgroundColor = 'var(--primary-bg)';
			macroValueEl.textContent = ''; // 初始为空
			macroValueEl.setAttribute('data-placeholder', 'Example: NAME=VALUE');
			
			// 添加占位符逻辑
			function updatePlaceholder() {
				if (macroValueEl.textContent.trim() === '') {
					macroValueEl.style.color = 'var(--text-muted)';
					macroValueEl.textContent = macroValueEl.getAttribute('data-placeholder');
				} else {
					macroValueEl.style.color = 'var(--text-color)';
				}
			}
			
			// 初始化占位符
			updatePlaceholder();
			
			// 添加点击事件以清除占位符
			macroValueEl.addEventListener('click', function() {
				if (macroValueEl.textContent === macroValueEl.getAttribute('data-placeholder')) {
					macroValueEl.textContent = '';
					macroValueEl.style.color = 'var(--text-color)';
				}
			});
			
			// 添加失去焦点事件以恢复占位符
							macroValueEl.addEventListener('blur', function() {
								updatePlaceholder();
							});
							 
							// 添加键盘事件
							macroValueEl.addEventListener('keydown', function(event) {
								if (event.key === 'Enter' || event.key === 'Escape') {
									event.preventDefault();
									macroValueEl.blur();
								}
							});
			
			// 使元素可编辑
			macroValueEl.contentEditable = true;
			
			// 创建删除按钮
			const removeButton = document.createElement('button');
			removeButton.className = 'remove-macro-button';
			removeButton.style.backgroundColor = 'transparent';
			removeButton.style.border = 'none';
			removeButton.style.color = 'var(--text-muted)';
			removeButton.style.cursor = 'pointer';
			removeButton.style.padding = '4px';
			removeButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';

			// 添加删除事件
							removeButton.addEventListener('click', function() {
								macroItem.remove();
								saveCurrentConfiguration();
							});
			
			// 添加到列表
			macroItem.appendChild(macroValueEl);
			macroItem.appendChild(removeButton);
			document.querySelector('.macro-list').appendChild(macroItem);
			
			// 自动聚焦到新创建的宏项
			macroValueEl.click();
		});
		
		// 为现有删除按钮添加点击事件
				document.querySelectorAll('.remove-macro-button').forEach(button => {
					button.addEventListener('click', function() {
						this.parentElement.remove();
						saveCurrentConfiguration();
					});
				});
		
		// 获取VS Code API
		const vscode = acquireVsCodeApi();

		// 初始化编译器选择事件处理
		function initCompilerSelectHandler() {
			const compilerSelect = document.querySelector('.compiler-select');
			// 为编译器选择框添加变化事件
			compilerSelect.addEventListener('change', updateOptionsByCompiler);
			// 初始化时也执行一次，确保选项正确设置
			updateOptionsByCompiler();
		}

		// 根据选择的编译器更新其他选项的可用性
		function updateOptionsByCompiler() {
			const compilerSelect = document.querySelector('.compiler-select');
			const shaderTypeSelect = document.querySelector('.shader-type-select');
			const shaderModeSelect = document.querySelector('.shader-mode-select');
			const outputTypeSelect = document.querySelector('.output-type-select');
			const shaderLanguageSelect = document.querySelector('.shader-language-select');
			const selectedCompiler = compilerSelect.value;

			// 重置所有选项为可用状态
			Array.from(shaderModeSelect.options).forEach(option => {
				option.disabled = false;
			});
			Array.from(outputTypeSelect.options).forEach(option => {
				option.disabled = false;
			});
			Array.from(shaderLanguageSelect.options).forEach(option => {
				option.disabled = false;
			});
			Array.from(shaderTypeSelect.options).forEach(option => {
				option.disabled = false;
			});

			// 根据选择的编译器限制选项
			switch (selectedCompiler) {
				case 'dxc':
					// DXC编译器限制：
					// 1. 不支持ShaderMode为450和460的情况
					Array.from(shaderModeSelect.options).forEach(option => {
						if (option.value === '450' || option.value === '460') {
							option.disabled = true;
						}
					});
					
					// 2. 不支持OutputType为DXBC和HLSL情况
					Array.from(outputTypeSelect.options).forEach(option => {
						if (option.value === 'DXBC' || option.value === 'HLSL') {
							option.disabled = true;
						}
					});
					
					// 3. 仅支持ShaderLanguage为HLSL和HLSL2021情况
					Array.from(shaderLanguageSelect.options).forEach(option => {
						if (option.value !== 'hlsl' && option.value !== 'hlsl2021') {
							option.disabled = true;
						}
					});
					break;

				case 'fxc':
					// FXC编译器限制：
					// 1. 仅支持ShaderMode为sm5.0和sm5.1的情况
					Array.from(shaderModeSelect.options).forEach(option => {
						if (option.value !== '5_0' && option.value !== '5_1') {
							option.disabled = true;
						}
					});
					
					// 2. 仅支持OutputType为DXBC和HLSL-Preprocess情况
					Array.from(outputTypeSelect.options).forEach(option => {
						if (option.value !== 'DXBC' && option.value !== 'HLSL-Preprocess') {
							option.disabled = true;
						}
					});
					
					// 3. 仅支持ShaderLanguage为HLSL情况
					Array.from(shaderLanguageSelect.options).forEach(option => {
						if (option.value !== 'hlsl') {
							option.disabled = true;
						}
					});
                    
                    // 4. 仅支持ShaderType为Vertex, Pixel, Geometry, Hull, Domain, Compute情况
                    Array.from(shaderTypeSelect.options).forEach(option => {
                        const allowedTypes = ['vs', 'ps', 'gs', 'hs', 'ds', 'cs'];
                        if (!allowedTypes.includes(option.value)) {
                            option.disabled = true;
                        }
                    });
					break;

				case 'glslang':
					// GLSLang编译器限制：
					// 1. 仅支持ShaderMode为450和460的情况
					Array.from(shaderModeSelect.options).forEach(option => {
						if (option.value !== '450' && option.value !== '460') {
							option.disabled = true;
						}
					});
					
					// 2. 仅支持OutputType为SPIR-V，HLSL, GLSL和MSL情况
					Array.from(outputTypeSelect.options).forEach(option => {
						if (option.value !== 'SPIR-V' && option.value !== 'HLSL' && option.value !== 'GLSL' && option.value !== 'MSL') {
							option.disabled = true;
						}
					});
					
					// 3. 仅支持ShaderLanguage为HLSL和GLSL情况
					Array.from(shaderLanguageSelect.options).forEach(option => {
						if (option.value !== 'hlsl' && option.value !== 'glsl') {
							option.disabled = true;
						}
					});
					break;
			}

			// 确保当前选择的值是有效的，如果无效则选择第一个有效的选项
			ensureValidSelection(shaderModeSelect);
			ensureValidSelection(outputTypeSelect);
			ensureValidSelection(shaderLanguageSelect);
			ensureValidSelection(shaderTypeSelect);

			// 移除了初始化后的自动保存逻辑
		}

		// 确保选择框选中的是有效的选项，如果不是则选择第一个可用选项
		function ensureValidSelection(selectElement) {
			const currentValue = selectElement.value;
			const selectedOption = selectElement.querySelector(`option[value="${currentValue}"]`);
			
			// 如果当前选中的选项被禁用，选择第一个可用的选项
			if (!selectedOption || selectedOption.disabled) {
				const firstValidOption = Array.from(selectElement.options).find(option => !option.disabled);
				if (firstValidOption) {
					selectElement.value = firstValidOption.value;
				}
			}
		}

		// 编译按钮点击事件
		document.getElementById('compile-shader-button').addEventListener('click', function() {
			const compileButton = this;
			// 保存原始文本
			const originalText = compileButton.textContent;
			
			// 更改按钮状态为正在编译
			compileButton.textContent = 'Building';
			compileButton.disabled = true;
			compileButton.style.backgroundColor = 'var(--text-muted)';
			
			// 获取所有编译参数
			const compilerSelect = document.querySelector('.compiler-select');
			const shaderTypeSelect = document.querySelector('.shader-type-select');
			const shaderModeSelect = document.querySelector('.shader-mode-select');
			const outputTypeSelect = document.querySelector('.output-type-select');
			const entryPointInput = document.querySelector('.entry-point-input');
			const additionalOptionCheckbox = document.querySelector('.additional-option-checkbox');
			const additionalOptionInput = document.querySelector('.additional-option-input');
			const shaderLanguageSelect = document.querySelector('.shader-language-select');
			
			// 获取宏定义
			const macroItems = document.querySelectorAll('.macro-item .macro-value');
			const macros = Array.from(macroItems).map(item => item.textContent.trim());
			
			// 获取包含路径
			const includePathItems = document.querySelectorAll('.include-path-item .include-path-value');
			const includePaths = Array.from(includePathItems).map(item => item.textContent.trim());
			
			// 创建一个Promise来处理编译过程
			new Promise((resolve) => {
				// 发送编译命令和参数
				vscode.postMessage({
					command: 'compileShader',
					shaderLanguage: shaderLanguageSelect.value,
					compiler: compilerSelect.value,
					shaderType: shaderTypeSelect.value,
					shaderMode: shaderModeSelect.value,
					outputType: outputTypeSelect.value,
					entryPoint: entryPointInput.value.trim(),
					additionalOptionEnabled: additionalOptionCheckbox.checked,
					additionalOption: additionalOptionInput.value.trim(),
					shaderLanguage: shaderLanguageSelect.value,
					macros: macros,
					includePaths: includePaths,
					// 添加一个唯一标识符用于识别编译完成
					compileId: Date.now()
				});
				
				// 设置一个监听器来等待编译完成
				const handleCompileComplete = function(event) {
					const message = event.data;
					// 检查是否是编译完成的消息
					if (message.command === 'compileComplete') {
						window.removeEventListener('message', handleCompileComplete);
						resolve();
					}
				};
				
				// 添加消息监听器
				window.addEventListener('message', handleCompileComplete);
				
				// 添加超时处理，以防编译过程出错没有返回结果
				setTimeout(() => {
					window.removeEventListener('message', handleCompileComplete);
					resolve();
				}, 300000); // 300秒超时
			}).finally(() => {
				// 恢复按钮原始状态
				compileButton.textContent = originalText;
				compileButton.disabled = false;
				compileButton.style.backgroundColor = 'var(--accent-color)';
			});
		});
		
		
		// Include Path 列表功能实现
		// 添加Include Path按钮点击事件
		document.querySelector('.add-include-path-button').addEventListener('click', function() {
			// 发送消息给扩展程序，请求打开文件夹选择对话框
			vscode.postMessage({
				command: 'openIncludeFloderDialg'
			});
		});
		
		// 监听来自扩展程序的消息
		window.addEventListener('message', event => {
			const message = event.data;
			if (message.command === 'folderSelected' && message.path) {
				// 创建新的Include Path项
				const includePathItem = document.createElement('div');
				includePathItem.className = 'include-path-item';
				includePathItem.style.display = 'flex';
				includePathItem.style.alignItems = 'center';
				includePathItem.style.gap = '12px';
				includePathItem.style.padding = '4px 0';
				
				// 创建Include Path值显示
				const includePathValueEl = document.createElement('div');
				includePathValueEl.className = 'include-path-value';
				includePathValueEl.style.flexGrow = '1';
				includePathValueEl.style.padding = '4px 8px';
				includePathValueEl.style.border = '1px solid var(--border-color)';
				includePathValueEl.style.borderRadius = '4px';
				includePathValueEl.style.backgroundColor = 'var(--primary-bg)';
				includePathValueEl.textContent = message.path;
				includePathValueEl.contentEditable = true;
				
				// 创建删除按钮
				const removeButton = document.createElement('button');
				removeButton.className = 'remove-include-path-button';
				removeButton.style.backgroundColor = 'transparent';
				removeButton.style.border = 'none';
				removeButton.style.color = 'var(--text-muted)';
				removeButton.style.cursor = 'pointer';
				removeButton.style.padding = '4px';
				removeButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
				
				// 添加删除事件
				removeButton.addEventListener('click', function() {
					includePathItem.remove();
					saveCurrentConfiguration();
				});
				
				// 添加到列表
				includePathItem.appendChild(includePathValueEl);
				includePathItem.appendChild(removeButton);
				document.querySelector('.include-path-list').appendChild(includePathItem);
				// 移除了添加后保存配置的逻辑
			} else if (message.command === 'compileResult' && message.result) {
				// TODO
			} else if (message.command === 'restoreConfiguration' && message.config) {
				// 恢复保存的配置
				restoreConfiguration(message.config);
			} else if (message.command === 'saveConfigurationOnBlur') {
				// 失去焦点时保存配置
				saveCurrentConfiguration();
			}
		});

		// 恢复配置函数
		function restoreConfiguration(config) {
			console.log('恢复配置开始...', config);
			// 恢复基本选择项
			if (config.compiler) document.querySelector('.compiler-select').value = config.compiler;
			if (config.shaderType) document.querySelector('.shader-type-select').value = config.shaderType;
			if (config.shaderMode) document.querySelector('.shader-mode-select').value = config.shaderMode;
			if (config.outputType) document.querySelector('.output-type-select').value = config.outputType;
			if (config.entryPoint) document.querySelector('.entry-point-input').value = config.entryPoint;
			if (config.additionalOptionEnabled !== undefined) document.querySelector('.additional-option-checkbox').checked = config.additionalOptionEnabled;
			if (config.additionalOption) document.querySelector('.additional-option-input').value = config.additionalOption;
			if (config.shaderLanguage) document.querySelector('.shader-language-select').value = config.shaderLanguage;
			
			// 恢复配置后应用选项限制逻辑
			updateOptionsByCompiler();

			// 恢复宏定义
			if (config.macros && Array.isArray(config.macros)) {
				const macroList = document.querySelector('.macro-list');
				// 清空现有宏列表（保留占位符或不保留，根据需要调整）
				macroList.innerHTML = '';

				config.macros.forEach(macroValue => {
					if (macroValue && macroValue.trim()) {
						// 创建宏定义项
						const macroItem = document.createElement('div');
						macroItem.className = 'macro-item';
						macroItem.style.display = 'flex';
						macroItem.style.alignItems = 'center';
						macroItem.style.gap = '12px';
						macroItem.style.padding = '4px 0';

						const macroValueEl = document.createElement('div');
						macroValueEl.className = 'macro-value';
						macroValueEl.style.flexGrow = '1';
						macroValueEl.style.padding = '4px 8px';
						macroValueEl.style.border = '1px solid var(--border-color)';
						macroValueEl.style.borderRadius = '4px';
						macroValueEl.style.backgroundColor = 'var(--primary-bg)';
						macroValueEl.textContent = macroValue;
						macroValueEl.setAttribute('data-placeholder', 'Example: NAME=VALUE');
						macroValueEl.contentEditable = true;

						// 添加占位符逻辑
						function updatePlaceholder() {
							if (macroValueEl.textContent.trim() === '') {
								macroValueEl.style.color = 'var(--text-muted)';
								macroValueEl.textContent = macroValueEl.getAttribute('data-placeholder');
							} else {
								macroValueEl.style.color = 'var(--text-color)';
							}
						}

						macroValueEl.addEventListener('blur', function() {
									updatePlaceholder();
								});

						const removeButton = document.createElement('button');
						removeButton.className = 'remove-macro-button';
						removeButton.style.backgroundColor = 'transparent';
						removeButton.style.border = 'none';
						removeButton.style.color = 'var(--text-muted)';
						removeButton.style.cursor = 'pointer';
						removeButton.style.padding = '4px';
						removeButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
						removeButton.addEventListener('click', function() {
							macroItem.remove();
							saveCurrentConfiguration();
						});

						macroItem.appendChild(macroValueEl);
						macroItem.appendChild(removeButton);
						macroList.appendChild(macroItem);
					}
				});
			}

			// 恢复包含路径
			if (config.includePaths && Array.isArray(config.includePaths)) {
				const includePathList = document.querySelector('.include-path-list');
				// 清空现有包含路径列表（保留占位符或不保留，根据需要调整）
				includePathList.innerHTML = '';

				config.includePaths.forEach(pathValue => {
					if (pathValue && pathValue.trim()) {
						// 创建Include Path项
						const includePathItem = document.createElement('div');
						includePathItem.className = 'include-path-item';
						includePathItem.style.display = 'flex';
						includePathItem.style.alignItems = 'center';
						includePathItem.style.gap = '12px';
						includePathItem.style.padding = '4px 0';

						const includePathValueEl = document.createElement('div');
								includePathValueEl.className = 'include-path-value';
								includePathValueEl.style.flexGrow = '1';
								includePathValueEl.style.padding = '4px 8px';
								includePathValueEl.style.border = '1px solid var(--border-color)';
								includePathValueEl.style.borderRadius = '4px';
								includePathValueEl.style.backgroundColor = 'var(--primary-bg)';
								includePathValueEl.textContent = pathValue;
								includePathValueEl.contentEditable = true;

						const removeButton = document.createElement('button');
						removeButton.className = 'remove-include-path-button';
						removeButton.style.backgroundColor = 'transparent';
						removeButton.style.border = 'none';
						removeButton.style.color = 'var(--text-muted)';
						removeButton.style.cursor = 'pointer';
						removeButton.style.padding = '4px';
						removeButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
						removeButton.addEventListener('click', function() {
							includePathItem.remove();
							saveCurrentConfiguration();
						});

						includePathItem.appendChild(includePathValueEl);
						includePathItem.appendChild(removeButton);
						includePathList.appendChild(includePathItem);
					}
				});
			}
		}

		// 保存当前配置函数
		function saveCurrentConfiguration() {
			console.log('保存配置开始...');
			// 获取所有配置项
			const compilerSelect = document.querySelector('.compiler-select');
			const shaderTypeSelect = document.querySelector('.shader-type-select');
			const shaderModeSelect = document.querySelector('.shader-mode-select');
			const outputTypeSelect = document.querySelector('.output-type-select');
			const entryPointInput = document.querySelector('.entry-point-input');
			const additionalOptionCheckbox = document.querySelector('.additional-option-checkbox');
			const additionalOptionInput = document.querySelector('.additional-option-input');
			const shaderLanguageSelect = document.querySelector('.shader-language-select');
			
			// 获取宏定义
			const macroItems = document.querySelectorAll('.macro-item .macro-value');
			const macros = Array.from(macroItems).map(item => {
				const text = item.textContent.trim();
				const placeholder = item.getAttribute('data-placeholder');
				return text !== placeholder ? text : '';
			}).filter(text => text);
			
			// 获取包含路径
			const includePathItems = document.querySelectorAll('.include-path-item .include-path-value');
			const includePaths = Array.from(includePathItems).map(item => item.textContent.trim()).filter(path => path);
			
			// 构建配置对象
			const currentConfig = {
				compiler: compilerSelect.value,
				shaderType: shaderTypeSelect.value,
				shaderMode: shaderModeSelect.value,
				outputType: outputTypeSelect.value,
				entryPoint: entryPointInput.value.trim(),
				additionalOptionEnabled: additionalOptionCheckbox.checked,
				additionalOption: additionalOptionInput.value.trim(),
				shaderLanguage: shaderLanguageSelect.value,
				macros: macros,
				includePaths: includePaths
			};
			
			// 发送配置到扩展保存
			vscode.postMessage({
				command: 'saveConfiguration',
				config: currentConfig
			});
		}

		// 移除了所有自动保存的变更事件监听器

		// 为所有配置控件添加事件监听器
		function addConfigChangeListeners() {
			// 编译器选择器
			document.querySelector('.compiler-select').addEventListener('change', saveCurrentConfiguration);
			// 着色器类型选择器
			document.querySelector('.shader-type-select').addEventListener('change', saveCurrentConfiguration);
			// 着色器模式选择器
			document.querySelector('.shader-mode-select').addEventListener('change', saveCurrentConfiguration);
			// 输出类型选择器
			document.querySelector('.output-type-select').addEventListener('change', saveCurrentConfiguration);
			// 入口点输入框
			document.querySelector('.entry-point-input').addEventListener('change', saveCurrentConfiguration);
			// 附加选项复选框
			document.querySelector('.additional-option-checkbox').addEventListener('change', saveCurrentConfiguration);
			// 附加选项输入框
			document.querySelector('.additional-option-input').addEventListener('change', saveCurrentConfiguration);
			// 着色器语言选择器
			document.querySelector('.shader-language-select').addEventListener('change', saveCurrentConfiguration);

			// 宏定义相关事件
			document.querySelector('.add-macro-button').addEventListener('click', function() {
				// 等DOM更新完成后保存
				setTimeout(saveCurrentConfiguration, 0);
			});
			// 为所有宏定义删除按钮添加事件
			document.addEventListener('click', function(e) {
				if (e.target.classList.contains('remove-macro-button')) {
					saveCurrentConfiguration();
				}
			});
			// 宏定义内容修改事件
			document.addEventListener('blur', function(e) {
				if (e.target.classList.contains('macro-value')) {
					saveCurrentConfiguration();
				}
			});
			// 宏定义实时修改事件
			document.addEventListener('input', function(e) {
				if (e.target.classList.contains('macro-value')) {
					saveCurrentConfiguration();
				}
			});

			// 包含路径相关事件
			document.querySelector('.add-include-path-button').addEventListener('click', function() {
				// 等DOM更新完成后保存
				setTimeout(saveCurrentConfiguration, 0);
			});
			// 为所有包含路径删除按钮添加事件
			document.addEventListener('click', function(e) {
				if (e.target.classList.contains('remove-include-path-button')) {
					saveCurrentConfiguration();
				}
			});
			// 包含路径内容修改事件
			document.addEventListener('blur', function(e) {
				if (e.target.classList.contains('include-path-value')) {
					saveCurrentConfiguration();
				}
			});
			// 包含路径实时修改事件
			document.addEventListener('input', function(e) {
				if (e.target.classList.contains('include-path-value')) {
					saveCurrentConfiguration();
				}
			});
		}

		// 初始化编译器选择事件处理
		initCompilerSelectHandler();

		// 添加配置变更事件监听器
		addConfigChangeListeners();

		// 为现有删除按钮添加点击事件
		document.querySelectorAll('.remove-include-path-button').forEach(button => {
			button.addEventListener('click', function() {
				this.parentElement.remove();
			});
		});

		
		// 允许宏值双击编辑
		document.addEventListener('dblclick', function(e) {
			if (e.target.classList.contains('macro-value')) {
				const currentValue = e.target.textContent;
				const input = document.createElement('input');
				input.type = 'text';
				input.value = currentValue;
				input.style.width = '100%';
				input.style.padding = '4px 8px';
				input.style.backgroundColor = 'var(--primary-bg)';
				input.style.color = 'var(--text-color)';
				input.style.border = '1px solid var(--accent-color)';
				input.style.borderRadius = '4px';
				
				e.target.parentNode.replaceChild(input, e.target);
				input.focus();
				
				// 失去焦点时保存
				input.addEventListener('blur', function() {
					const newValue = input.value.trim();
					const macroValueEl = document.createElement('div');
					macroValueEl.className = 'macro-value';
					macroValueEl.style.flexGrow = '1';
					macroValueEl.style.padding = '4px 8px';
					macroValueEl.style.border = '1px solid var(--border-color)';
					macroValueEl.style.borderRadius = '4px';
					macroValueEl.style.backgroundColor = 'var(--primary-bg)';
					macroValueEl.textContent = newValue || currentValue;
					input.parentNode.replaceChild(macroValueEl, input);
					// 保存配置
					saveCurrentConfiguration();
				});
				
				// 按Enter键保存
				input.addEventListener('keydown', function(e) {
					if (e.key === 'Enter') {
						input.blur();
					}
				});
			}
		});

		// 菜单功能实现
		(function() {
			// 获取标题栏中的菜单按钮和弹出菜单
			const menuButton = document.getElementById('menuButton');
			const menuPopup = document.getElementById('menuPopup');
			const versionNumber = document.getElementById('versionNumber');

			// 菜单按钮鼠标悬停效果
			menuButton.addEventListener('mouseover', function() {
				this.style.backgroundColor = 'var(--tertiary-bg)';
			});
			menuButton.addEventListener('mouseout', function() {
				this.style.backgroundColor = 'transparent';
			});

			// 菜单按钮点击事件
			menuButton.addEventListener('click', function(event) {
				event.stopPropagation();
				menuPopup.style.display = menuPopup.style.display === 'none' ? 'block' : 'none';
			});

			// 点击页面其他地方关闭菜单
			document.addEventListener('click', function(event) {
				if (event.target !== menuButton && !menuPopup.contains(event.target)) {
					menuPopup.style.display = 'none';
				}
			});

			// 接收版本信息
			window.addEventListener('message', function(event) {
				const message = event.data;
				if (message.command === 'setVersion') {
					versionNumber.textContent = message.version;
				}
			});
		})();
	});
</script>
</body>
</html>